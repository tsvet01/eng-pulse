name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  PROJECT_ID: tsvet01
  REGION: us-central1
  REPO_NAME: agent-repo
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy-agents:
    runs-on: ubuntu-latest
    # Only deploy if CI passed (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
    - uses: actions/checkout@v4

    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker Auth
      run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    # --- Daily Agent ---
    - name: Build & Push Daily Agent (Cloud Build)
      run: |
        gcloud builds submit \
          --config=apps/daily-agent/cloudbuild.yaml \
          --substitutions=_IMAGE_TAG=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/se-daily-agent:${{ env.IMAGE_TAG }} \
          --machine-type=E2_HIGHCPU_8 \
          .

    - name: Deploy Daily Agent Job
      run: |
        # First clear any existing env var/secret conflict
        gcloud run jobs update se-daily-agent-job \
          --region ${{ env.REGION }} \
          --project ${{ env.PROJECT_ID }} \
          --remove-env-vars GEMINI_API_KEY \
          --clear-secrets || true
        # Then deploy with the secret
        gcloud run jobs deploy se-daily-agent-job \
          --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/se-daily-agent:${{ env.IMAGE_TAG }} \
          --region ${{ env.REGION }} \
          --project ${{ env.PROJECT_ID }} \
          --set-secrets GEMINI_API_KEY=gemini-api-key:latest \
          --task-timeout 5m

    # --- Explorer Agent ---
    - name: Build & Push Explorer Agent (Cloud Build)
      run: |
        gcloud builds submit \
          --config=apps/explorer-agent/cloudbuild.yaml \
          --substitutions=_IMAGE_TAG=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/se-explorer-agent:${{ env.IMAGE_TAG }} \
          --machine-type=E2_HIGHCPU_8 \
          .

    - name: Deploy Explorer Agent Job
      run: |
        # First clear any existing env var/secret conflict
        gcloud run jobs update se-explorer-agent-job \
          --region ${{ env.REGION }} \
          --project ${{ env.PROJECT_ID }} \
          --remove-env-vars GEMINI_API_KEY \
          --clear-secrets || true
        # Then deploy with the secret
        gcloud run jobs deploy se-explorer-agent-job \
          --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/se-explorer-agent:${{ env.IMAGE_TAG }} \
          --region ${{ env.REGION }} \
          --project ${{ env.PROJECT_ID }} \
          --set-secrets GEMINI_API_KEY=gemini-api-key:latest \
          --task-timeout 30m

  deploy-notifier:
    runs-on: ubuntu-latest
    needs: deploy-agents
    steps:
    - uses: actions/checkout@v4

    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Deploy Notifier Function
      run: |
        cd functions/notifier
        gcloud functions deploy se-daily-notifier \
          --gen2 \
          --runtime=python311 \
          --region=${{ env.REGION }} \
          --source=. \
          --entry-point=send_summary_email \
          --trigger-event-filters="type=google.cloud.storage.object.v1.finalized" \
          --trigger-event-filters="bucket=${{ env.PROJECT_ID }}-agent-brain" \
          --clear-env-vars \
          --set-secrets "GMAIL_USER=gmail-user:latest,GMAIL_APP_PASSWORD=gmail-app-password:latest,DEST_EMAIL=dest-email:latest" \
          --project ${{ env.PROJECT_ID }}
